# Windows AKS Azure marketplace images

## Motivation

The primary motivation for producing AKS specific Windows VHDs is to improve the reliability and deployment time for the configuration phase of Windows nodes configured by aks-engine. 
By performing expensive configuration options and pre-downloading installation artifacts as part of the VHD build process we can accomplish both of these goals.

Producing and publishing AKS specific Windows VHDs to the Azure marketplace also allow us to get targeted windows patches to customers sooner. 
Today the WIndows/Windows Server team only publish new images containing the latest B week patches. Several times recently C week patches contain fixes to issues customers are facing running Kubernetes on Windows nodes. This means customers would either need to wait an additional 3-4 weeks to get these fixes or another mechanism to developed these patches to Windows nodes would need to be developed.

Lastly publishing AKS specific Windows VHDs allows us to perform adequate testing on new patches before allowing customers to customers to upgrade their Windows nodes.
In the first half of 2019 monthly security fixes broke Kubernetes workloads on Windows a few different occasions forcing the the aks-engine team to start hard-coding the specific versions of the Windows Server marketplace images (instead of targeting latest). 
This needs to be resolved by collaborating and testing with the Windows team before patches get released publicly regardless.

## Build Process

Windows AKS VHDs are produced using [packer](www.packer.io) in an [Azure DevOps](dev.azure.com) build pipeline.

The packer job provisions a new VM in Azure based off a specified Windows Server image and:
- Installs/enables required Windows components/features
- Download multiple versions of components which users are allowed to specify the version of (Kubernetes, Docker, etc)
- Downloads commonly used container images
- Configure system settings (windows update, page file sizes, etc)

Note: See scripts referenced below to for further details

### Build Resources

- Azure DevOps build yaml build definition: [.pipelines/vhd-builder-windows.yaml](../../.pipelines/vhd-builder-windows.yaml)
- Packer job definition: [packer/windows-vhd-builder.json](../../packer/windows-vhd-builder.json)
- Customization script used in packer: [packer/configure-windows-vhd.ps1](../../packer/configure-windows-vhd.ps1)

## Usage in aks-engine

Both Windows and Linux nodes are configured by executing Custom Script Extensions as part of VM deployment operations.
The scripts are generated by aks-engine which populates instance specific information from the [cluster definition API model](clusterdefinitions.md) and get embedded into the ARM templates produced by AKS engine. These scripts are enlightened to understand the work in conjunction with Windows AKS marketplace images to not duplicate configuration steps and/or utilize files cached during the VHD build process.

[Parts/k8s/kuberneteswindowssetup.ps1](../../parts/k8s/kuberneteswindowssetup.ps1) and associated ps1 files are used as templates for the extension scripts.

It is an explicit goal to maintain aks-engine compatibility with 'vanilla' Windows Server marketplace images (for most scenarios) and to treat the Windows AKS marketplace images as an optimization for the reasons stated above.
